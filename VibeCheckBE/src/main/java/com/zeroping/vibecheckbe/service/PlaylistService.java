package com.zeroping.vibecheckbe.service;

import com.zeroping.vibecheckbe.dto.SavePlaylistToSpotifyRequest;
import com.zeroping.vibecheckbe.entity.Playlist;
import com.zeroping.vibecheckbe.entity.User;
import com.zeroping.vibecheckbe.exception.user.UserNotFoundException;
import com.zeroping.vibecheckbe.repository.PlaylistRepository;
import com.zeroping.vibecheckbe.repository.UserRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.IOException;

@Service
public class PlaylistService {

    private final PlaylistRepository playlistRepository;
    private final UserRepository userRepository;
    private final SpotifyService spotifyService;

    public PlaylistService(PlaylistRepository playlistRepository, 
                          UserRepository userRepository,
                          SpotifyService spotifyService) {
        this.playlistRepository = playlistRepository;
        this.userRepository = userRepository;
        this.spotifyService = spotifyService;
    }

    @Transactional
    public void savePlaylistToSpotify(Long userId, SavePlaylistToSpotifyRequest request) throws IOException {
        // Get user and validate
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new UserNotFoundException(userId));

        if (user.getSpotifyAccessToken() == null || user.getSpotifyAccessToken().isEmpty()) {
            throw new IllegalStateException("User does not have a Spotify access token");
        }

        // Get playlist and validate
        Playlist playlist = playlistRepository.findByIdAndUserId(request.getPlaylistId(), userId)
                .orElseThrow(() -> new IllegalArgumentException("Playlist not found or does not belong to user"));

        // Check if already exported
        if (Boolean.TRUE.equals(playlist.getExportedToSpotify())) {
            throw new IllegalStateException("Playlist has already been exported to Spotify");
        }

        // Validate playlist has tracks
        if (playlist.getTrackUris() == null || playlist.getTrackUris().isEmpty()) {
            throw new IllegalStateException("Playlist has no tracks to export");
        }

        String accessToken = user.getSpotifyAccessToken();

        // Get Spotify user ID
        String spotifyUserId = spotifyService.getCurrentUserId(accessToken);

        // Create playlist in Spotify
        String spotifyPlaylistId = spotifyService.createPlaylist(
                accessToken,
                spotifyUserId,
                request.getSpotifyPlaylistName(),
                "Generated by AI"
        );

        // Add tracks to Spotify playlist
        spotifyService.addTracksToPlaylist(accessToken, spotifyPlaylistId, playlist.getTrackUris());

        // Update playlist in database
        playlist.setExportedToSpotify(true);
        playlist.setSpotifyPlaylistId(spotifyPlaylistId);
        playlistRepository.save(playlist);
    }
}
